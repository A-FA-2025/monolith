<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>A-FA Stream View</title>
  <link rel="shortcut icon" href="/assets/favicon.svg" type="image/svg+xml">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: white;
      text-align: center;
      font-family: 'Nanum Gothic', sans-serif;
    }

    .logo {
      width: 180px;
      margin: 30px auto 10px;
      cursor: pointer;
    }

    h2 {
      margin-top: 10px;
      font-size: 24px;
      font-weight: bold;
    }

    .container {
      display: inline-block;
      position: relative;
    }

    canvas {
      width: 1024px;
      height: 768px;
      border: 3px solid #f1c40f;
      border-radius: 12px;
      margin-top: 20px;
    }

    #stats-box {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: rgba(241, 196, 15, 0.9);
      color: black;
      padding: 12px 18px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      z-index: 9999;
    }

    #status-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #f1c40f;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      max-width: 300px;
      text-align: left;
      z-index: 9999;
      transition: opacity 0.4s ease;
    }

    .action-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 20px;
      margin-top: 20px;
      padding-right: 10%;
    }

    .footer-buttons {
      margin: 40px auto;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .btn {
      padding: 14px 28px;
      font-size: 16px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
      color: white;
      transition: 0.3s ease;
    }

    .btn.red { background-color: #e74c3c; }
    .btn.red:hover { background-color: #c0392b; }

    .btn.green { background-color: #2ecc71; }
    .btn.green:hover { background-color: #27ae60; }

    .btn.yellow { background-color: #f1c40f; }
    .btn.yellow:hover { background-color: #f39c12; }

    .btn.blue { background-color: #3498db; }
    .btn.blue:hover { background-color: #2980b9; }

    @media (max-width: 1000px) {
      canvas { width: 100%; height: auto; }
      .footer-buttons,
      .action-buttons {
        flex-direction: column;
        align-items: center;
        gap: 15px;
        padding-right: 0;
      }
    }
  </style>
</head>
<body>
  <div id="stats-box" style="display:none;">
    FPS: <span id="fps">0</span> | ì§€ì—°: <span id="latency">0</span> ms
  </div>

  <div id="status-box" style="display: none;">ğŸ”„ ìƒíƒœ ì´ˆê¸°í™” ì¤‘...</div>

  <a href="/"><img src="assets/A-FA.png" alt="A-FA Logo" class="logo"></a>

  <h2>WebSocket Live Stream</h2>

  <div id="auth-container">
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="padding:10px; font-size:16px;">
    <button onclick="submitPassword()" style="padding:10px 20px;">ì ‘ì†</button>
    <p id="auth-msg" style="margin-top:10px; color: red;"></p>
  </div>

  <div class="container" style="display:none;" id="video-container">
    <canvas id="canvas" width="640" height="480"></canvas>
    <div class="action-buttons">
      <button onclick="logout()" class="btn red">ğŸ”’ ì ‘ì† ì¢…ë£Œ</button>
      <button id="start-recording" class="btn green">ğŸ”´ ë…¹í™” ì‹œì‘</button>
    </div>
  </div>

  <div class="footer-buttons">
    <a href="/live.html" class="btn red">ğŸ”´ ì‹¤ì‹œê°„ ì›ê²© ê³„ì¸¡ í—ˆë¸Œ</a>
    <a href="/review" class="btn yellow">ğŸŸ¡ ê³„ì¸¡ ë¡œê·¸ ë¦¬ë·°</a>
    <a href="/review/video.html" class="btn blue">ğŸ”µ ë…¹í™” ì˜ìƒ ë³´ê¸°</a>
  </div>

<script>
  let socket;
  let isRecording = false;
  const statusBox = document.getElementById("status-box");

  function updateStatus(message, timeout = 4000) {
    statusBox.textContent = message;
    statusBox.style.display = "block";
    clearTimeout(updateStatus._timeout);
    updateStatus._timeout = setTimeout(() => {
      statusBox.style.display = "none";
    }, timeout);
  }

  if (sessionStorage.getItem("authenticated") === "true") {
    connectWithoutPrompt();
  }

  function submitPassword() {
    const password = document.getElementById("password").value;
    socket = new WebSocket("wss://afa2025.ddns.net:7000");
    socket.binaryType = "blob";
    socket.onopen = () => socket.send("auth:" + password);
    socket.onmessage = handleAuthResponse;
    updateStatus("ğŸ” ì¸ì¦ ìš”ì²­ ì¤‘...");
  }

  function connectWithoutPrompt() {
    socket = new WebSocket("wss://afa2025.ddns.net:7000");
    socket.binaryType = "blob";
    socket.onopen = () => socket.send("auth:afa2025");
    socket.onmessage = handleAuthResponse;
    updateStatus("ğŸ” ìë™ ì¸ì¦ ìš”ì²­ ì¤‘...");
  }

  function handleAuthResponse(event) {
    const msg = event.data;
    if (msg === "auth:success") {
      sessionStorage.setItem("authenticated", "true");
      document.getElementById("auth-container").style.display = "none";
      document.getElementById("video-container").style.display = "block";
      document.getElementById("stats-box").style.display = "block";
      updateStatus("âœ… ì¸ì¦ ì™„ë£Œ. ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì¤‘...");
      startStreaming();
    } else if (msg === "auth:wrong") {
      document.getElementById("auth-msg").textContent = "âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
      updateStatus("âŒ ì¸ì¦ ì‹¤íŒ¨: ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
      socket.close();
    } else if (msg === "auth:fail") {
      document.getElementById("auth-msg").textContent = "âŒ ì ‘ì†ìê°€ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.";
      updateStatus("âŒ ì¸ì¦ ì‹¤íŒ¨: ì¤‘ë³µ ì ‘ì†");
      socket.close();
    } else if (msg === "auth:required") {
      document.getElementById("auth-msg").textContent = "âŒ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.";
      updateStatus("âŒ ì¸ì¦ ì‹¤íŒ¨: ì¸ì¦ í•„ìš”");
      socket.close();
    } else {
      sessionStorage.removeItem("authenticated");
      document.getElementById("auth-msg").textContent = "âŒ ì¸ì¦ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
      updateStatus("âŒ ì¸ì¦ ì‹¤íŒ¨: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
      document.getElementById("auth-container").style.display = "block";
      socket.close();
    }
  }

  function logout() {
    sessionStorage.removeItem("authenticated");
    localStorage.removeItem("recording");
    location.reload();
  }

  function startStreaming() {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const fpsDisplay = document.getElementById("fps");
    const latencyDisplay = document.getElementById("latency");
    const img = new Image();
    let frameCount = 0;
    let lastTime = Date.now();

    img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    socket.onmessage = (event) => {
      if (typeof event.data === "string") {
        if (event.data.startsWith("pong:")) {
          latencyDisplay.textContent = Date.now() - parseInt(event.data.split(":")[1]);
        } else if (event.data.includes("upload_done")) {
          updateStatus("âœ… ë…¹í™”ë³¸ ì—…ë¡œë“œ ë° ë³€í™˜ ì™„ë£Œ!", 5000);
        } else if (event.data.includes("upload_fail")) {
          updateStatus("âŒ ë…¹í™”ë³¸ ì—…ë¡œë“œ ì‹¤íŒ¨", 5000);
        }
      } else if (event.data instanceof Blob) {
        frameCount++;
        img.src = URL.createObjectURL(event.data);
      }
    };

    setInterval(() => socket.send("ping:" + Date.now()), 3000);
    setInterval(() => {
      const now = Date.now();
      fpsDisplay.textContent = Math.round(frameCount / ((now - lastTime) / 1000));
      frameCount = 0;
      lastTime = now;
    }, 1000);

    const recordButton = document.getElementById("start-recording");
    recordButton.addEventListener("click", async () => {
      if (!isRecording) {
        const filename = prompt("ì €ì¥í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”", "session1");
        if (!filename) return;
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const fullFilename = `${filename}_${timestamp}`;
        const payload = { action: "start_video_recording", filename: fullFilename };
        console.log("ğŸ“¤ ë…¹í™” ì‹œì‘ ëª…ë ¹ ì „ì†¡:", payload);
        updateStatus("ğŸ“½ï¸ ë…¹í™” ì‹œì‘ ì¤‘...", 4000);
        socket.send(JSON.stringify(payload));
        recordButton.textContent = "â¹ ë…¹í™” ì •ì§€";
        recordButton.classList.remove("green");
        recordButton.classList.add("red");
        isRecording = true;
      } else {
        console.log("ğŸ“¤ ë…¹í™” ì •ì§€ ëª…ë ¹ ì „ì†¡");
        updateStatus("ğŸ“¤ ë…¹í™” ì •ì§€ ìš”ì²­ â†’ ì—…ë¡œë“œ ì²˜ë¦¬ ì¤‘...", 5000);
        socket.send(JSON.stringify({ action: "stop_video_recording" }));
        recordButton.textContent = "ğŸ”´ ë…¹í™” ì‹œì‘";
        recordButton.classList.remove("red");
        recordButton.classList.add("green");
        isRecording = false;
      }
    });
  }
</script>
</body>
</html>
